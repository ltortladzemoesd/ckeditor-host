<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Talking Points Preview</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>

  <!-- html2canvas + jsPDF (replacing html2pdf) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    html, body { margin:0; padding:0; }
    body {
      font-family: Arial, sans-serif;
      background:#fff;
      color:#000;
      display:flex;
      justify-content:center;
    }

    /* 210 mm @ 96 dpi ≈ 794 px */
    .wrapper {
      width:794px;
      padding:40px;          /* ≈ 15 mm visual margin inside the page */
      box-sizing:border-box;
      background:#fff;
    }

    #saveBtn{
      position:fixed; top:10px; left:10px;
      font-size:12px; padding:6px 12px;
      background:#2c3e50; color:#fff;
      border:none; border-radius:12px; cursor:pointer; z-index:1000;
    }
    @media print { #saveBtn{ display:none!important; } }

    h1{ font-size:24px; margin-bottom:5px; }
    #currentDate{ font-size:12px; margin-bottom:20px; color:#444; }
    h2{ font-size:18px; margin-top:40px; border-bottom:1px solid #ccc; padding-bottom:6px; }
    .section-content{ margin-bottom:40px; break-inside:avoid; page-break-inside:avoid; }
  </style>
</head>
<body>
  <button id="saveBtn" onclick="savePDF()">Save as PDF</button>

  <div class="wrapper" id="pdfContent">
    <h1 id="countryHeading">Talking Points</h1>
    <div id="currentDate"></div>
    <div id="contentContainer">Loading...</div>
  </div>

  <script>
    /* --- helper --- */
    function escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

    /* --- Firebase init (unchanged) --- */
    const firebaseConfig={ apiKey:"AIzaSyAH6IH8c9imo9xlIoxpjVzVcgVIMqqgR2g",
      authDomain:"ckeditor-content-saver.firebaseapp.com",
      projectId:"ckeditor-content-saver",
      storageBucket:"ckeditor-content-saver.appspot.com",
      messagingSenderId:"429325764295",
      appId:"1:429325764295:web:ef0006899c4461e1afa0e2" };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    /* --- page heading & date (unchanged) --- */
    const urlParams=new URLSearchParams(window.location.search);
    const country=urlParams.get("country")||"UnknownCountry";
    document.getElementById("countryHeading").innerText=`Talking Points: ${country.replace(/_/g," ")}`;
    document.getElementById("currentDate").innerText=new Date().toLocaleDateString("en-GB").replaceAll('/','.');

    /* --- sections loader (unchanged) --- */
    const sections={
      Diplomatic_Relations:"Diplomatic Relations",
      Bilateral_Trade_and_Economic_Relations:"Bilateral Trade and Economic Relations",
      Trade_Policy:"Trade Policy", Tourism:"Tourism", Investment:"Investment",
      Transport:"Transport", Energy:"Energy",
      "Communications,_Innovation_and_Post":"Communications, Innovation and Post",
      Information_Technology:"Information Technology"};
    const contentContainer=document.getElementById("contentContainer");
    let isContentLoaded=false;

    (async function loadAllSections(){
      for(const [key,title] of Object.entries(sections)){
        const docId=`${country}_${key}_tp`;
        const sec=document.createElement("div");
        sec.className="section-content";
        try{
          const doc=await db.collection("ckeditor-content").doc(docId).get();
          if(doc.exists){
            sec.innerHTML=`<h2>${escapeHtml(title)}</h2>`;
            sec.insertAdjacentHTML("beforeend",doc.data().content);
          }else{
            sec.innerHTML=`<h2>${escapeHtml(title)}</h2><p style="color:gray;"><em>No content found for ${docId}</em></p>`;
          }
        }catch(e){
          sec.innerHTML=`<h2>${escapeHtml(title)}</h2><p style="color:red;">Error: ${e.message}</p>`;
        }
        contentContainer.appendChild(sec);
      }
      isContentLoaded=true;
    })();

    /* --- new savePDF using html2canvas + jsPDF --- */
    async function savePDF(){
      const btn=document.getElementById("saveBtn");
      btn.style.display='none';

      /* wait until sections are loaded */
      while(!isContentLoaded) await new Promise(r=>setTimeout(r,100));

      const element=document.getElementById("pdfContent");
      const canvas=await html2canvas(element,{scale:2,useCORS:true});
      const imgData=canvas.toDataURL("image/jpeg",1.0);

      const { jsPDF }=window.jspdf;
      const pdf=new jsPDF({orientation:'p',unit:'mm',format:'a4'});

      const pageW=210, pageH=297, margin=15;
      const imgW=pageW-2*margin;
      const imgH=canvas.height*imgW/canvas.width;

      pdf.addImage(imgData,'JPEG',margin,margin,imgW,imgH,'','FAST');
      pdf.save(`Talking_Points_${country}.pdf`);

      btn.style.display='block';
    }
  </script>
</body>
</html>
