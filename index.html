<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CKEditor with Firebase</title>
  <script src="https://cdn.ckeditor.com/4.22.1/full/ckeditor.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>
  <script src="https://rawcdn.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f2f2f2;
    }
    h2 {
      margin-top: 30px;
    }
    .section {
      border: 1px solid #ccc;
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
    }
    .ckeditor-label {
      font-weight: bold;
      margin-top: 10px;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
      margin: 10px 5px;
      cursor: pointer;
    }
    select {
      font-size: 16px;
      padding: 5px;
      margin-bottom: 20px;
    }
    #status {
      font-weight: bold;
      margin-top: 10px;
    }
    .cke_notification_warning {
      display: none !important;
    }
  </style>
</head>
<body>

<h1>Information Document</h1>
<select id="countrySelect">
  <option value="">Choose a country</option>
  <option value="Georgia">Georgia</option>
  <option value="Hungary">Hungary</option>
  <option value="Germany">Germany</option>
</select>

<div id="sectionsContainer"></div>

<div id="status"></div>
<button onclick="saveAll()">Save All</button>
<button onclick="previewAll()">Preview</button>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAH6IH8c9imo9xlIoxpjVzVcgVIMqqgR2g",
    authDomain: "ckeditor-content-saver.firebaseapp.com",
    projectId: "ckeditor-content-saver",
    storageBucket: "ckeditor-content-saver.appspot.com",
    messagingSenderId: "429325764295",
    appId: "1:429325764295:web:ef0006899c4461e1afa0e2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const sections = [
    "MFA", "Trade Statistics", "Trade Policy", "Investments",
    "Tourism", "Transport", "Energy", "Communications", "Innovation"
  ];

  const editorInstances = {};

  function getCountry() {
    return document.getElementById("countrySelect").value.trim();
  }

  document.getElementById("countrySelect").addEventListener("change", () => {
    const country = getCountry();
    if (!country) return;

    const container = document.getElementById("sectionsContainer");
    container.innerHTML = "";

    sections.forEach((sectionKey) => {
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const infoId = `${safeKey}_info`;
      const discussionId = `${safeKey}_discussion`;

      const div = document.createElement("div");
      div.className = "section";
      div.innerHTML = `
        <h2>${sectionKey}</h2>
        <div class="ckeditor-label">Information Document:</div>
        <textarea id="${infoId}"></textarea>
        <div class="ckeditor-label">Discussion Points:</div>
        <textarea id="${discussionId}"></textarea>
      `;
      container.appendChild(div);

      CKEDITOR.replace(infoId, { height: 150 });
      CKEDITOR.replace(discussionId, { height: 150 });

      editorInstances[infoId] = CKEDITOR.instances[infoId];
      editorInstances[discussionId] = CKEDITOR.instances[discussionId];
    });

    // Load data
    sections.forEach((sectionKey) => {
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const infoRef = db.collection("ckeditor-content").doc(`${country}_${safeKey}_info`);
      const discussionRef = db.collection("ckeditor-content").doc(`${country}_${safeKey}_discussion`);

      infoRef.get().then(doc => {
        if (doc.exists) editorInstances[`${safeKey}_info`].setData(doc.data().content);
      });

      discussionRef.get().then(doc => {
        if (doc.exists) editorInstances[`${safeKey}_discussion`].setData(doc.data().content);
      });
    });
  });

  function saveAll() {
    const country = getCountry();
    if (!country) {
      alert("Please select a country first.");
      return;
    }

    const status = document.getElementById("status");
    let promises = [];

    sections.forEach((sectionKey) => {
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const infoContent = editorInstances[`${safeKey}_info`].getData();
      const discussionContent = editorInstances[`${safeKey}_discussion`].getData();

      const infoRef = db.collection("ckeditor-content").doc(`${country}_${safeKey}_info`);
      const discussionRef = db.collection("ckeditor-content").doc(`${country}_${safeKey}_discussion`);

      promises.push(infoRef.set({ content: infoContent }));
      promises.push(discussionRef.set({ content: discussionContent }));
    });

    Promise.all(promises).then(() => {
      status.innerText = "✅ Successfully Saved";
      status.style.color = "green";
    }).catch((err) => {
      status.innerText = "❌ Error: " + err.message;
      status.style.color = "red";
    });
  }

  function previewAll() {
    const country = getCountry();
    if (!country) {
      alert("Please select a country first.");
      return;
    }

    let html = `<html><head><title>${country} Preview</title>
      <style>
        body { font-family: Arial; padding: 40px; line-height: 1.6; background: #fff; color: #000; }
        h1 { text-align: center; }
        h2 { margin-top: 30px; color: #1a1a1a; }
        h3 { margin-top: 10px; color: #333; }
        hr { margin: 30px 0; }
      </style>
    </head><body>
    <h1>${country}</h1>`;

    sections.forEach((sectionKey) => {
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const info = editorInstances[`${safeKey}_info`].getData();
      const discussion = editorInstances[`${safeKey}_discussion`].getData();

      html += `<h2>${sectionKey}</h2>`;
      html += `<h3>Information Document</h3>${info}`;
      html += `<h3>Discussion Points</h3>${discussion}`;
      html += `<hr>`;
    });

    html += `</body></html>`;

    const previewWindow = window.open("", "_blank");
    previewWindow.document.open();
    previewWindow.document.write(html);
    previewWindow.document.close();
  }
</script>

</body>
</html>
