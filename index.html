<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Country Editor</title>

  <!-- CKEditor -->
  <script src="https://cdn.ckeditor.com/4.22.1/full/ckeditor.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>

  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
  body {
    font-family: Arial;
    padding: 20px;
    background: #f9f9f9;
  }

  select, button {
    margin: 10px 0;
    padding: 8px;
    font-size: 16px;
  }

  .section {
    margin-top: 20px;
    background: #fff;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
  }

  .section summary {
    font-weight: bold;
    font-size: 18px;
    cursor: pointer;
  }

  label {
    margin-top: 10px;
    font-weight: bold;
    display: block;
  }

  #status {
    margin-top: 10px;
    font-weight: bold;
  }

  /* 🔒 Hide insecure version warning from CKEditor */
  .cke_notification_warning {
    display: none !important;
  }
</style>

</head>
<body>
  <h2>Choose a Country</h2>
  <select id="countrySelect">
    <option value="">-- Select Country --</option>
    <option value="GEORGIA">Georgia</option>
    <option value="HUNGARY">Hungary</option>
    <option value="GERMANY">Germany</option>
  </select>

  <div id="editorSections"></div>

  <button onclick="saveAll()">Save All</button>
  <button onclick="previewAll()">Preview</button>

  <div id="status"></div>

  <div id="pdfContainer" style="display:none;"></div>


  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAH6IH8c9imo9xlIoxpjVzVcgVIMqqgR2g",
      authDomain: "ckeditor-content-saver.firebaseapp.com",
      projectId: "ckeditor-content-saver",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const sections = [
      "MFA", "Trade Statistics", "Trade Policy", "Investments",
      "Tourism", "Transport", "Energy", "Communications", "Innovation"
    ];

    const editorInstances = {};
    const editorSections = document.getElementById("editorSections");

    // Load sections
    sections.forEach((sectionKey) => {
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");

      const container = document.createElement("details");
      container.className = "section";
      container.innerHTML = `
        <summary>${sectionKey}</summary>
        <label for="${safeKey}_info">Information Document</label>
        <textarea id="${safeKey}_info">Loading...</textarea>

        <label for="${safeKey}_discussion">Discussion Points</label>
        <textarea id="${safeKey}_discussion">Loading...</textarea>
      `;
      editorSections.appendChild(container);
    });

    // Initialize CKEditor after DOM ready
    window.addEventListener("load", () => {
      sections.forEach((sectionKey) => {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        ["info", "discussion"].forEach((type) => {
          const id = `${safeKey}_${type}`;
          editorInstances[id] = CKEDITOR.replace(id, {
            height: 200,
            toolbar: [
              { name: 'styles', items: ['Format', 'Font', 'FontSize'] },
              { name: 'colors', items: ['TextColor', 'BGColor'] },
              { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline'] },
              { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent'] },
              { name: 'alignment', items: ['JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
              { name: 'insert', items: ['Table', 'Image', 'Link'] },
              { name: 'tools', items: ['Maximize'] }
            ]
          });
        });
      });
    });

    document.getElementById("countrySelect").addEventListener("change", () => {
      const country = getCountry();
      if (!country) return;

      sections.forEach((sectionKey) => {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        ["info", "discussion"].forEach((type) => {
          const id = `${safeKey}_${type}`;
          const docRef = db.collection("ckeditor-content").doc(country).collection(sectionKey).doc(type);
          docRef.get().then((doc) => {
            const data = doc.exists ? doc.data().html : "";
            editorInstances[id].setData(data);
          });
        });
      });

      document.getElementById("status").innerText = "Content loaded for " + country;
    });

    function getCountry() {
      return document.getElementById("countrySelect").value.trim().toUpperCase();
    }

    function saveAll() {
      const country = getCountry();
      if (!country) {
        alert("Please select a country first.");
        return;
      }

      const promises = [];

      sections.forEach((sectionKey) => {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        ["info", "discussion"].forEach((type) => {
          const id = `${safeKey}_${type}`;
          const content = editorInstances[id].getData();
          const docRef = db.collection("ckeditor-content").doc(country).collection(sectionKey).doc(type);
          promises.push(docRef.set({ html: content }));
        });
      });

      Promise.all(promises).then(() => {
        document.getElementById("status").innerText = "✅ Successfully Saved";
        document.getElementById("status").style.color = "green";
      }).catch((err) => {
        document.getElementById("status").innerText = "❌ Error: " + err.message;
        document.getElementById("status").style.color = "red";
      });
    }

    function exportAll() {
  const country = getCountry();
  if (!country) {
    alert("Please select a country first.");
    return;
  }

  const container = document.getElementById("pdfContainer");
  container.innerHTML = ""; // clear previous

  sections.forEach((sectionKey) => {
    const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
    const info = editorInstances[`${safeKey}_info`].getData();
    const discussion = editorInstances[`${safeKey}_discussion`].getData();

    container.innerHTML += `<h2>${sectionKey}</h2>`;
    container.innerHTML += `<h3>Information Document</h3>${info}`;
    container.innerHTML += `<h3>Discussion Points</h3>${discussion}`;
    container.innerHTML += `<hr>`;
  });

  // Make container temporarily visible to html2pdf
  container.style.display = "block";
  html2pdf()
    .from(container)
    .set({ margin: 10, filename: `${country}-report.pdf` })
    .save()
    .then(() => {
      container.style.display = "none"; // hide again
    });
}

    <script>
  function previewAll() {
    const country = getCountry();
    if (!country) {
      alert("Please select a country first.");
      return;
    }

    let html = `<html><head><title>${country} Preview</title>
      <style>
        body { font-family: Arial; padding: 40px; line-height: 1.6; background: #fff; color: #000; }
        h1 { text-align: center; }
        h2 { margin-top: 30px; color: #1a1a1a; }
        h3 { margin-top: 10px; color: #333; }
        hr { margin: 30px 0; }
      </style>
    </head><body>
    <h1>${country}</h1>`;

    sections.forEach((sectionKey) => {
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const info = editorInstances[`${safeKey}_info`].getData();
      const discussion = editorInstances[`${safeKey}_discussion`].getData();

      html += `<h2>${sectionKey}</h2>`;
      html += `<h3>Information Document</h3>${info}`;
      html += `<h3>Discussion Points</h3>${discussion}`;
      html += `<hr>`;
    });

    html += `</body></html>`;

    const previewWindow = window.open("", "_blank");
    previewWindow.document.open();
    previewWindow.document.write(html);
    previewWindow.document.close();
  }
</script>

  </script>
</body>
</html>
