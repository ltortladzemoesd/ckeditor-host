<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CKEditor Country Fields</title>
  <script src="https://cdn.ckeditor.com/4.22.1/full/ckeditor.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial;
      margin: 40px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
    }
    select, button {
      font-size: 16px;
      padding: 6px 12px;
      margin: 10px 0;
    }
    .section {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      background: #fff;
    }
    .ckeditor-label {
      margin-top: 10px;
      font-weight: bold;
    }
    .cke_notification_warning {
      display: none !important;
    }
  </style>
</head>
<body>

  <h1>Country Editor</h1>

  <label for="countrySelect">Choose Country:</label>
  <select id="countrySelect">
    <option value="">-- Select --</option>
    <option>Georgia</option>
    <option>Germany</option>
    <option>France</option>
  </select>

  <div id="editorContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAH6IH8c9imo9xlIoxpjVzVcgVIMqqgR2g",
      authDomain: "ckeditor-content-saver.firebaseapp.com",
      projectId: "ckeditor-content-saver",
      storageBucket: "ckeditor-content-saver.appspot.com",
      messagingSenderId: "429325764295",
      appId: "1:429325764295:web:ef0006899c4461e1afa0e2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const sections = [
      "MFA", "Trade Statistics", "Trade Policy", "Investments",
      "Tourism", "Transport", "Energy", "Communications", "Innovation"
    ];

    const editorInstances = {};

    const countrySelect = document.getElementById("countrySelect");
    const editorContainer = document.getElementById("editorContainer");

    countrySelect.addEventListener("change", async () => {
      editorContainer.innerHTML = "";

      const country = countrySelect.value;
      if (!country) return;

      for (const sectionKey of sections) {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        const infoId = `${safeKey}_info`;
        const discussionId = `${safeKey}_discussion`;

        const div = document.createElement("div");
        div.className = "section";
        div.innerHTML = `
          <h2>${sectionKey}</h2>
          <div class="ckeditor-label">Information Document:</div>
          <textarea id="${infoId}"></textarea>
          <button onclick="saveSingleField('${sectionKey}', 'info')">üíæ Save Info</button>
          <button onclick="previewSingleField('${sectionKey}', 'info')">üëÅÔ∏è Preview Info</button>
          <br><br>
          <div class="ckeditor-label">Discussion Points:</div>
          <textarea id="${discussionId}"></textarea>
          <button onclick="saveSingleField('${sectionKey}', 'discussion')">üíæ Save Discussion</button>
          <button onclick="previewSingleField('${sectionKey}', 'discussion')">üëÅÔ∏è Preview Discussion</button>
          <br><br>
          <span id="${safeKey}_status" style="font-weight: bold;"></span>
        `;
        editorContainer.appendChild(div);

        // Initialize editors
        editorInstances[infoId] = CKEDITOR.replace(infoId, { height: 200 });
        editorInstances[discussionId] = CKEDITOR.replace(discussionId, { height: 200 });

        // Load saved data
        const infoRef = doc(db, "ckeditor-content", `${country}_${safeKey}_info`);
        const discussionRef = doc(db, "ckeditor-content", `${country}_${safeKey}_discussion`);

        const [infoSnap, discussionSnap] = await Promise.all([getDoc(infoRef), getDoc(discussionRef)]);
        if (infoSnap.exists()) editorInstances[infoId].setData(infoSnap.data().content);
        if (discussionSnap.exists()) editorInstances[discussionId].setData(discussionSnap.data().content);
      }
    });

    window.getCountry = () => document.getElementById("countrySelect").value;

    window.saveSingleField = async (sectionKey, type) => {
      const country = getCountry();
      if (!country) {
        alert("Please select a country.");
        return;
      }

      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const fieldId = `${safeKey}_${type}`;
      const content = editorInstances[fieldId].getData();
      const ref = doc(db, "ckeditor-content", `${country}_${safeKey}_${type}`);
      const status = document.getElementById(`${safeKey}_status`);

      status.innerText = "Saving...";
      try {
        await setDoc(ref, { content });
        status.innerText = `‚úÖ ${type === 'info' ? 'Information' : 'Discussion'} Saved`;
        status.style.color = "green";
      } catch (err) {
        status.innerText = `‚ùå Error: ${err.message}`;
        status.style.color = "red";
      }
    };

    window.previewSingleField = (sectionKey, type) => {
      const country = getCountry();
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const fieldId = `${safeKey}_${type}`;
      const content = editorInstances[fieldId].getData().trim();

      if (!content) {
        alert("This field is empty.");
        return;
      }

      const title = type === "info" ? "Information Document" : "Discussion Points";

      const html = `<html><head><title>${title} - ${sectionKey}</title>
        <style>
          body { font-family: Arial; padding: 40px; line-height: 1.6; background: #fff; color: #000; }
          h1, h2 { text-align: center; }
          h3 { margin-top: 20px; }
        </style>
      </head><body>
      <h1>${country}</h1>
      <h2>${sectionKey}</h2>
      <h3>${title}</h3>
      ${content}
      </body></html>`;

      const previewWindow = window.open("", "_blank");
      previewWindow.document.open();
      previewWindow.document.write(html);
      previewWindow.document.close();
    };
  </script>
</body>
</html>
