<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CKEditor Country Fields</title>
  <script src="https://cdn.ckeditor.com/4.22.1/full/ckeditor.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial;
      margin: 40px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
    }
    select, button {
      font-size: 16px;
      padding: 8px 16px;
      margin: 10px 10px 10px 0;
      border-radius: 12px;
      border: none;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .section {
      margin-bottom: 20px;
      background: #fff;
      padding: 12px;
      border-radius: 16px;
    }
    .section-header {
      background: #eee;
      padding: 16px;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
      border-radius: 12px;
    }
    .section-content {
      display: none;
      padding: 20px;
    }
    .ckeditor-label {
      margin-top: 10px;
      font-weight: bold;
    }
    .cke_notification_warning {
      display: none !important;
    }
    #controls {
      margin-bottom: 20px;
    }
    #globalPreviewButtons {
      display: none;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>

  <h1>Country Editor</h1>

  <div id="controls">
    <label for="countrySelect">Choose Country:</label>
    <select id="countrySelect">
      <option value="">-- Select --</option>
      <option>Georgia</option>
      <option>Germany</option>
      <option>France</option>
    </select>
  </div>

  <div id="globalPreviewButtons">
    <button onclick="previewEntireDocument('info')">Preview Info Doc</button>
    <button onclick="previewEntireDocument('talking')">Preview TPs</button>
  </div>

  <div id="editorContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAH6IH8c9imo9xlIoxpjVzVcgVIMqqgR2g",
      authDomain: "ckeditor-content-saver.firebaseapp.com",
      projectId: "ckeditor-content-saver",
      storageBucket: "ckeditor-content-saver.appspot.com",
      messagingSenderId: "429325764295",
      appId: "1:429325764295:web:ef0006899c4461e1afa0e2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const sections = [
      "International Relations", "Trade Statistics", "Trade Policy", "Investments",
      "Tourism", "Transport", "Energy", "Communications", "Innovation"
    ];

    const editorInstances = {};

    const countrySelect = document.getElementById("countrySelect");
    const editorContainer = document.getElementById("editorContainer");
    const globalPreviewButtons = document.getElementById("globalPreviewButtons");

    countrySelect.addEventListener("change", async () => {
      editorContainer.innerHTML = "";

      const country = countrySelect.value;
      if (!country) {
        globalPreviewButtons.style.display = "none";
        return;
      } else {
        globalPreviewButtons.style.display = "block";
      }

      const promises = sections.map(async (sectionKey) => {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        const infoId = `${safeKey}_info`;
        const talkingId = `${safeKey}_talking`;

        const wrapper = document.createElement("div");
        wrapper.className = "section";

        wrapper.innerHTML = `
          <div class="section-header" onclick="const content = this.nextElementSibling; content.style.display = content.style.display === 'block' ? 'none' : 'block';">
            ${sectionKey}
          </div>
          <div class="section-content">
            <div class="ckeditor-label">Information Document:</div>
            <textarea id="${infoId}"></textarea>
            <button onclick="saveSingleField('${sectionKey}', 'info')">Save</button>
            <button onclick="previewSingleField('${sectionKey}', 'info')">Preview</button>

            <div class="ckeditor-label" style="margin-top:20px;">Talking Points:</div>
            <textarea id="${talkingId}"></textarea>
            <button onclick="saveSingleField('${sectionKey}', 'talking')">Save TPs</button>
            <button onclick="previewSingleField('${sectionKey}', 'talking')">Preview TPs</button>
            <br><br>
            <span id="${safeKey}_status" style="font-weight: bold;"></span>
          </div>
        `;

        editorContainer.appendChild(wrapper);

        editorInstances[infoId] = CKEDITOR.replace(infoId, {
          height: 200,
          toolbar: [
            { name: 'styles', items: ['Format', 'Font', 'FontSize'] },
            { name: 'colors', items: ['TextColor', 'BGColor'] },
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent'] },
            { name: 'alignment', items: ['JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
            { name: 'insert', items: ['Table', 'Link'] },
            { name: 'tools', items: ['Maximize'] }
          ]
        });

        editorInstances[talkingId] = CKEDITOR.replace(talkingId, {
          height: 200,
          toolbar: [
            { name: 'styles', items: ['Format', 'Font', 'FontSize'] },
            { name: 'colors', items: ['TextColor', 'BGColor'] },
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent'] },
            { name: 'alignment', items: ['JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
            { name: 'insert', items: ['Table', 'Link'] },
            { name: 'tools', items: ['Maximize'] }
          ]
        });

        const [infoSnap, talkingSnap] = await Promise.all([
          getDoc(doc(db, "ckeditor-content", `${country}_${safeKey}_info`)),
          getDoc(doc(db, "ckeditor-content", `${country}_${safeKey}_talking`))
        ]);

        if (infoSnap.exists()) editorInstances[infoId].setData(infoSnap.data().content);
        if (talkingSnap.exists()) editorInstances[talkingId].setData(talkingSnap.data().content);
      });

      await Promise.all(promises);
    });

    window.getCountry = () => document.getElementById("countrySelect").value;

    window.saveSingleField = async (sectionKey, type) => {
      const country = getCountry();
      if (!country) return alert("Select a country");

      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const fieldId = `${safeKey}_${type}`;
      const content = editorInstances[fieldId].getData();
      const status = document.getElementById(`${safeKey}_status`);

      status.innerText = "Saving...";
      try {
        await setDoc(doc(db, "ckeditor-content", `${country}_${safeKey}_${type}`), { content });
        status.innerText = `✅ ${type === 'info' ? 'Information' : 'TPs'} Saved`;
        status.style.color = "green";
      } catch (err) {
        status.innerText = `❌ Error: ${err.message}`;
        status.style.color = "red";
      }
    };

    window.previewSingleField = (sectionKey, type) => {
      const country = getCountry();
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
      const fieldId = `${safeKey}_${type}`;
      const content = editorInstances[fieldId].getData().trim();

      if (!content) return alert("This field is empty");

      const title = type === "info" ? "Information Document" : "Talking Points";
      const html = `<html><head><title>${title}</title>
        <style>body { font-family: Arial; padding: 40px; line-height: 1.6; background: #fff; color: #000; } h1, h2 { text-align: center; }</style>
      </head><body>
        <h1>${country}</h1>
        <h2>${sectionKey}</h2>
        <h3>${title}</h3>
        ${content}
      </body></html>`;

      const win = window.open();
      win.document.open();
      win.document.write(html);
      win.document.close();
    };

    window.previewEntireDocument = (type) => {
      const country = getCountry();
      if (!country) return alert("Select a country");

      let fullContent = `<html><head><title>${type === 'info' ? 'Information Document' : 'Talking Points'}</title>
        <style>body { font-family: Arial; padding: 40px; line-height: 1.6; } h1, h2 { text-align: center; }</style>
        </head><body><h1>${country}</h1><h2>${type === 'info' ? 'Information Document' : 'Talking Points'}</h2>`;

      for (const sectionKey of sections) {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        const fieldId = `${safeKey}_${type}`;
        const content = editorInstances[fieldId]?.getData().trim();
        if (content) {
          fullContent += `<h3>${sectionKey}</h3>` + content;
        }
      }

      fullContent += '</body></html>';

      const win = window.open();
      win.document.open();
      win.document.write(fullContent);
      win.document.close();
    };
  </script>
</body>
</html>
