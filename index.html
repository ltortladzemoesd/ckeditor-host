<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Country Editor</title>

  <!-- CKEditor -->
  <script src="https://cdn.ckeditor.com/4.22.1/full/ckeditor.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>

  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
  body {
    font-family: Arial;
    padding: 20px;
    background: #f9f9f9;
  }

  select, button {
    margin: 10px 0;
    padding: 8px;
    font-size: 16px;
  }

  .section {
    margin-top: 20px;
    background: #fff;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
  }

  .section summary {
    font-weight: bold;
    font-size: 18px;
    cursor: pointer;
  }

  label {
    margin-top: 10px;
    font-weight: bold;
    display: block;
  }

  #status {
    margin-top: 10px;
    font-weight: bold;
  }

  /* 🔒 Hide insecure version warning from CKEditor */
  .cke_notification_warning {
    display: none !important;
  }
</style>

</head>
<body>
  <h2>Choose a Country</h2>
  <select id="countrySelect">
    <option value="">-- Select Country --</option>
    <option value="GEORGIA">Georgia</option>
    <option value="HUNGARY">Hungary</option>
    <option value="GERMANY">Germany</option>
  </select>

  <div id="editorSections"></div>

  <button onclick="saveAll()">Save All</button>
  <button onclick="exportAll()">Export PDF</button>
  <div id="status"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAH6IH8c9imo9xlIoxpjVzVcgVIMqqgR2g",
      authDomain: "ckeditor-content-saver.firebaseapp.com",
      projectId: "ckeditor-content-saver",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const sections = [
      "MFA", "Trade Statistics", "Trade Policy", "Investments",
      "Tourism", "Transport", "Energy", "Communications", "Innovation"
    ];

    const editorInstances = {};
    const editorSections = document.getElementById("editorSections");

    // Load sections
    sections.forEach((sectionKey) => {
      const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");

      const container = document.createElement("details");
      container.className = "section";
      container.innerHTML = `
        <summary>${sectionKey}</summary>
        <label for="${safeKey}_info">Information Document</label>
        <textarea id="${safeKey}_info">Loading...</textarea>

        <label for="${safeKey}_discussion">Discussion Points</label>
        <textarea id="${safeKey}_discussion">Loading...</textarea>
      `;
      editorSections.appendChild(container);
    });

    // Initialize CKEditor after DOM ready
    window.addEventListener("load", () => {
      sections.forEach((sectionKey) => {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        ["info", "discussion"].forEach((type) => {
          const id = `${safeKey}_${type}`;
          editorInstances[id] = CKEDITOR.replace(id, {
            height: 200,
            toolbar: [
              { name: 'styles', items: ['Format', 'Font', 'FontSize'] },
              { name: 'colors', items: ['TextColor', 'BGColor'] },
              { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline'] },
              { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent'] },
              { name: 'alignment', items: ['JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
              { name: 'insert', items: ['Table', 'Image', 'Link'] },
              { name: 'tools', items: ['Maximize'] }
            ]
          });
        });
      });
    });

    document.getElementById("countrySelect").addEventListener("change", () => {
      const country = getCountry();
      if (!country) return;

      sections.forEach((sectionKey) => {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        ["info", "discussion"].forEach((type) => {
          const id = `${safeKey}_${type}`;
          const docRef = db.collection("ckeditor-content").doc(country).collection(sectionKey).doc(type);
          docRef.get().then((doc) => {
            const data = doc.exists ? doc.data().html : "";
            editorInstances[id].setData(data);
          });
        });
      });

      document.getElementById("status").innerText = "Content loaded for " + country;
    });

    function getCountry() {
      return document.getElementById("countrySelect").value.trim().toUpperCase();
    }

    function saveAll() {
      const country = getCountry();
      if (!country) {
        alert("Please select a country first.");
        return;
      }

      const promises = [];

      sections.forEach((sectionKey) => {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        ["info", "discussion"].forEach((type) => {
          const id = `${safeKey}_${type}`;
          const content = editorInstances[id].getData();
          const docRef = db.collection("ckeditor-content").doc(country).collection(sectionKey).doc(type);
          promises.push(docRef.set({ html: content }));
        });
      });

      Promise.all(promises).then(() => {
        document.getElementById("status").innerText = "✅ Successfully Saved";
        document.getElementById("status").style.color = "green";
      }).catch((err) => {
        document.getElementById("status").innerText = "❌ Error: " + err.message;
        document.getElementById("status").style.color = "red";
      });
    }

    function exportAll() {
      const container = document.createElement("div");

      sections.forEach((sectionKey) => {
        const safeKey = sectionKey.toLowerCase().replace(/\s/g, "_");
        const info = editorInstances[`${safeKey}_info`].getData();
        const discussion = editorInstances[`${safeKey}_discussion`].getData();

        container.innerHTML += `<h2>${sectionKey}</h2>`;
        container.innerHTML += `<h3>Information Document</h3>${info}`;
        container.innerHTML += `<h3>Discussion Points</h3>${discussion}`;
        container.innerHTML += `<hr>`;
      });

      html2pdf().from(container).save(getCountry() + "-report.pdf");
    }
  </script>
</body>
</html>
